# ğŸ“˜ MikroTik Manager

AplicaciÃ³n web desarrollada en **PHP + MySQL** con frontend en **LeafletJS + JavaScript** para la gestiÃ³n y monitoreo de routers MikroTik vÃ­a  **REST API RouterOS** .

---

## ğŸš€ VisiÃ³n General

**Objetivos principales:**

* Administrar routers ( **alta, ediciÃ³n, baja** ).
* Consultar estado en tiempo real ( **modelo, uptime, CPU, ARP, logs** ).
* Mostrar la ubicaciÃ³n de cada router en un  **mapa interactivo** .
* Guardar posiciones manuales ( **arrastrando marcadores o clic derecho** ).
* Monitoreo programado con **cron** y generaciÃ³n de logs.
* **Importar/exportar routers** en formato JSON.
* BÃºsqueda por **nombre/IP** y bÃºsqueda de direcciones (OpenStreetMap/Nominatim).
* Panel de configuraciÃ³n con pestaÃ±as:  **General, Backup, Logs, Routers** .

---

## ğŸ—ï¸ Arquitectura

* **Frontend:**

  HTML + CSS (dark/light theme) + JavaScript (LeafletJS).
* **Backend:**

  PHP 8 + librerÃ­a personalizada `ros_rest_client.php` (consumo REST Mikrotik).
* **Base de datos:**

  MySQL (tabla principal `routers`).
* **Infraestructura:**

  Desplegado en **XAMPP (Windows)** con cron vÃ­a Programador de Tareas.
* **Integraciones externas:**

  * OpenStreetMap (Leaflet tiles).
  * Nominatim (geocodificaciÃ³n direcciones).
  * RouterOS REST API (`/rest/system/resource`, `/rest/log`, `/rest/ip/arp`, etc.).

---

## ğŸ“‚ Estructura de Archivos

<pre class="overflow-visible!" data-start="1583" data-end="2053"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span>mk/
 â”œâ”€â”€ api/
 â”‚    â”œâ”€â”€ add_router.php
 â”‚    â”œâ”€â”€ edit_router.php
 â”‚    â”œâ”€â”€ delete_router.php
 â”‚    â”œâ”€â”€ update_location.php
 â”‚    â”œâ”€â”€ get_routers.php
 â”‚    â”œâ”€â”€ get_router_details.php
 â”‚    â”œâ”€â”€ heartbeat.php
 â”‚    â”œâ”€â”€ trigger_action.php
 â”‚    â”œâ”€â”€ db_connect.php
 â”‚    â”œâ”€â”€ ros_rest_client.php
 â”‚    â””â”€â”€ cache/ (JSON de routers para tooltips)
 â”‚
 â”œâ”€â”€ cron/
 â”‚    â”œâ”€â”€ check_status.php
 â”‚    â””â”€â”€ logs/ (logs diarios cron)
 â”‚
 â”œâ”€â”€ index.html
 â”œâ”€â”€ map.js
 â””â”€â”€ styles.css
</span></span></code></div></div></pre>

---

## ğŸ—„ï¸ Base de Datos

**Tabla `routers`:**

| Campo        | Tipo                  | DescripciÃ³n           |
| ------------ | --------------------- | ---------------------- |
| id           | INT PK AI             | Identificador Ãºnico   |
| name         | VARCHAR(100)          | Nombre amigable        |
| ip_address   | VARCHAR(255)          | IP o dominio           |
| api_user     | VARCHAR(100)          | Usuario API            |
| api_password | VARCHAR(100)          | ContraseÃ±a API        |
| api_port     | INT                   | Puerto REST (ej. 8333) |
| api_ssl      | TINYINT               | 0 = http, 1 = https    |
| lat          | DOUBLE                | Latitud                |
| lng          | DOUBLE                | Longitud               |
| status       | ENUM(OK,FAIL,PENDING) | Estado actual          |
| model        | VARCHAR(100)          | Modelo Router          |
| version      | VARCHAR(50)           | VersiÃ³n RouterOS      |
| uptime       | VARCHAR(50)           | Tiempo encendido       |
| cpu_load     | INT                   | Carga CPU              |
| last_checked | DATETIME              | Ãšltima verificaciÃ³n  |

---

## ğŸ”„ Flujo de Trabajo

1. **Alta de router**
   * Modal con clic derecho en mapa o botÃ³n â€œAgregarâ€.
   * Se completan  **nombre, IP, user, pass, puerto** .
   * InserciÃ³n vÃ­a `add_router.php`.
2. **EdiciÃ³n**
   * Popup â†’ botÃ³n â€œEditarâ€.
   * ActualizaciÃ³n vÃ­a `edit_router.php`.
3. **EliminaciÃ³n**
   * Popup â†’ botÃ³n â€œEliminarâ€.
   * `delete_router.php`.
4. **ActualizaciÃ³n de estado**
   * AutomÃ¡tica: cada 5 min con `cron/check_status.php`.
   * Manual: botÃ³n â€œğŸ”„â€ en popup (`check_single_router.php`).
   * Global: botÃ³n â€œVerificar todos ahoraâ€.
5. **Posicionamiento**
   * Clic derecho â†’ modal con coordenadas.
   * Arrastre marcador â†’ `update_location.php`.

---

## â²ï¸ Cron â€” `check_status.php`

Configurado cada 5 minutos en Windows:

<pre class="overflow-visible!" data-start="3993" data-end="4068"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre! language-bat"><span>C:\xampp\php\php.exe -f C:\xampp\htdocs\mk\cron\check_status.php
</span></code></div></div></pre>

**Acciones:**

* Recorre todos los routers en DB.
* Llama a `/system/resource`, `/system/routerboard`, `/log`, `/ip/arp`.
* Actualiza DB y genera **JSON cache** en `api/cache/router_ID.json`.
* Filtra logs en  **error, critical, warning** .
* Escribe log diario en `cron/logs/cron-rest-YYYY-MM-DD.log`.

---

## ğŸ–¥ï¸ Frontend (map.js + Leaflet)

**Funciones principales:**

* `createMarker(router)` â†’ crea marcador en mapa.
* `updateRouterLocation()` â†’ guarda nuevas coordenadas.
* `getRouterDetailsCached()` â†’ lee JSON cache y arma tooltip.
* `buildTooltipHTML()` â†’ modelo, uptime, CPU, ARP, eventos.
* `fetchAndDrawRouters()` â†’ sincroniza DB â†” mapa.
* `checkRouterNow()` â†’ verificaciÃ³n individual.
* `deleteRouter()` â†’ elimina router.
* `searchInput` â†’ bÃºsqueda por nombre/IP.
* `addressInput` â†’ bÃºsqueda de direcciones OSM.
* `renderRoutersTable()` â†’ tabla de routers en pestaÃ±a  *Routers* .

**Botones flotantes:**

* ğŸŒ™ **theme-btn** â†’ alternar tema.
* âš™ **settings-btn** â†’ abrir modal configuraciÃ³n.
* ğŸ”’ **lock-btn** â†’ activar/desactivar arrastre.
* ğŸ”„ **check-all-btn** â†’ verificar todos los routers.

---

## ğŸ”§ Backend

**Archivos clave:**

* `add_router.php`, `edit_router.php` â†’ CRUD de routers.
* `delete_router.php` â†’ elimina router.
* `update_location.php` â†’ guarda coordenadas.
* `get_router_details.php` â†’ devuelve JSON cache.
* `heartbeat.php` â†’ refresco en vivo del mapa.
* `trigger_action.php` â†’ acciones globales (ej: `FORCE_CHECK_ALL`).
* `ros_rest_client.php` â†’ wrapper REST RouterOS.

---

## âš™ï¸ Panel de ConfiguraciÃ³n

* **General:** parÃ¡metros de cron + vista mapa.
* **Backup:** importar/exportar routers con progreso.
* **Logs:** selector dinÃ¡mico (cron, routers, auditorÃ­a).
* **Routers:** tabla HTML con listado y estado.

---

## ğŸ“Œ Mejoras Pendientes

* [ ] Sincronizar posiciÃ³n al agregar router con clic derecho ( **bug lng=-55** ).
* [ ] Mejorar validaciones (IP/host).
* [ ] Cifrar `api_password` en DB.
* [ ] PaginaciÃ³n/scroll infinito en tabla de routers.
* [ ] AuditorÃ­a: registrar acciones de usuario.
* [ ] Migrar cron a systemd o Docker en Linux.
* [ ] Tooltips mÃ¡s completos (RAM, interfaces activas).

---

## âœ… Estado actual

* La aplicaciÃ³n es  **funcional** : agregar, editar, eliminar y monitorear routers Mikrotik vÃ­a REST.
* Datos en **MySQL** y estado en  **JSON cache** .
* Soporta **import/export** en JSON.
* Arquitectura modular: fÃ¡cil extender tanto **backend (api/)** como  **frontend (pestaÃ±as, UI)** .
