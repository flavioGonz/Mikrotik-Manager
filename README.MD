# ğŸ“˜ DocumentaciÃ³n TÃ©cnica â€” **MikroTik Manager**

## 1. VisiÃ³n General

AplicaciÃ³n web desarrollada en **PHP + MySQL** con frontend en **LeafletJS + JavaScript** para la **gestiÃ³n y monitoreo de routers MikroTik** vÃ­a  **REST API RouterOS** .

Objetivos principales:

* Administrar routers (alta, ediciÃ³n, baja).
* Consultar estado en tiempo real (modelo, uptime, CPU, ARP, logs).
* Mostrar la ubicaciÃ³n de cada router en un mapa interactivo.
* Guardar posiciones manuales arrastrando marcadores o clic derecho.
* Monitoreo programado con cron y generaciÃ³n de logs.
* Importar/exportar routers en formato JSON.
* BÃºsqueda por nombre/IP y bÃºsqueda de direcciones (OpenStreetMap/Nominatim).
* Panel de configuraciÃ³n con pestaÃ±as  **General, Backup, Logs, Routers** .

---

## 2. Arquitectura

* **Frontend** : HTML + CSS (custom, dark/light theme) + JavaScript (Leaflet).
* **Backend** : PHP 8, librerÃ­a personalizada `ros_rest_client.php` para consumo de REST MikroTik.
* **Base de datos** : MySQL (tabla principal `routers`).
* **Infraestructura** : Desplegado en  **XAMPP (Windows)** , con cron configurado vÃ­a  *Programador de Tareas* .
* **Integraciones externas** :
* OpenStreetMap (Leaflet tiles).
* Nominatim (geocodificaciÃ³n direcciones).
* RouterOS REST API (`/rest/system/resource`, `/rest/log`, `/rest/ip/arp`, etc.).

---

## 3. Estructura de Archivos

<pre class="overflow-visible!" data-start="1714" data-end="2184"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span>mk/
 â”œâ”€â”€ api/
 â”‚    â”œâ”€â”€ add_router.php
 â”‚    â”œâ”€â”€ edit_router.php
 â”‚    â”œâ”€â”€ delete_router.php
 â”‚    â”œâ”€â”€ update_location.php
 â”‚    â”œâ”€â”€ get_routers.php
 â”‚    â”œâ”€â”€ get_router_details.php
 â”‚    â”œâ”€â”€ heartbeat.php
 â”‚    â”œâ”€â”€ trigger_action.php
 â”‚    â”œâ”€â”€ db_connect.php
 â”‚    â”œâ”€â”€ ros_rest_client.php
 â”‚    â””â”€â”€ cache/ (JSON de routers para tooltips)
 â”‚
 â”œâ”€â”€ cron/
 â”‚    â”œâ”€â”€ check_status.php
 â”‚    â””â”€â”€ logs/ (logs diarios cron)
 â”‚
 â”œâ”€â”€ index.html
 â”œâ”€â”€ map.js
 â””â”€â”€ styles.css
</span></span></code></div></div></pre>

---

## 4. Base de Datos

 **Tabla `routers`** :

| Campo            | Tipo                  | DescripciÃ³n           |
| ---------------- | --------------------- | ---------------------- |
| `id`           | INT PK AI             | Identificador Ãºnico   |
| `name`         | VARCHAR(100)          | Nombre amigable        |
| `ip_address`   | VARCHAR(255)          | IP o dominio           |
| `api_user`     | VARCHAR(100)          | Usuario API            |
| `api_password` | VARCHAR(100)          | ContraseÃ±a API        |
| `api_port`     | INT                   | Puerto REST (ej. 8333) |
| `api_ssl`      | TINYINT               | 0 = http, 1 = https    |
| `lat`          | DOUBLE                | Latitud                |
| `lng`          | DOUBLE                | Longitud               |
| `status`       | ENUM(OK,FAIL,PENDING) | Estado                 |
| `model`        | VARCHAR(100)          | Modelo Router          |
| `version`      | VARCHAR(50)           | VersiÃ³n RouterOS      |
| `uptime`       | VARCHAR(50)           | Tiempo encendido       |
| `cpu_load`     | INT                   | Carga CPU              |
| `last_checked` | DATETIME              | Ãšltima verificaciÃ³n  |

---

## 5. Flujo de Trabajo

### 5.1. Alta de router

* Se abre modal con clic derecho en mapa o botÃ³n â€œAgregarâ€.
* Se completan  **nombre, IP, user, pass, puerto** .
* Se guardan **lat/lng** de la posiciÃ³n clickeada.
* InserciÃ³n vÃ­a `add_router.php`.

### 5.2. EdiciÃ³n

* Desde popup del marcador â†’ botÃ³n â€œEditarâ€.
* Se actualizan campos en `edit_router.php`.

### 5.3. EliminaciÃ³n

* Desde popup â†’ botÃ³n â€œEliminarâ€.
* Se elimina con `delete_router.php`.

### 5.4. ActualizaciÃ³n de estado

* AutomÃ¡tica: cada 5 min con `cron/check_status.php`.
* Manual: botÃ³n popup â€œğŸ”„â€ â†’ `check_single_router.php`.
* Manual global: botÃ³n flotante â€œVerificar todos ahoraâ€.

### 5.5. Posicionamiento

* Clic derecho â†’ abre modal con coordenadas de clic.
* Arrastre marcador â†’ `update_location.php`.

---

## 6. Cron (check_status.php)

* Corre cada 5 minutos vÃ­a Programador de Tareas:
  <pre class="overflow-visible!" data-start="3964" data-end="4040"><div class="contain-inline-size rounded-2xl relative bg-token-sidebar-surface-primary"><div class="sticky top-9"><div class="absolute end-0 bottom-0 flex h-9 items-center pe-2"><div class="bg-token-bg-elevated-secondary text-token-text-secondary flex items-center gap-4 rounded-sm px-2 font-sans text-xs"></div></div></div><div class="overflow-y-auto p-4" dir="ltr"><code class="whitespace-pre!"><span><span>C</span><span>:</span><span>\</span><span>xampp</span><span>\</span><span>php</span><span>\</span><span>php</span><span>.</span><span>exe</span><span></span><span>-</span><span>f</span><span></span><span>C</span><span>:</span><span>\</span><span>xampp</span><span>\</span><span>htdocs</span><span>\</span><span>mk</span><span>\</span><span>cron</span><span>\</span><span>check_status</span><span>.</span><span>php</span><span>
  </span></span></code></div></div></pre>
* Acciones:
  * Recorre todos los routers de la DB.
  * Llama a `/system/resource`, `/system/routerboard`, `/log`, `/ip/arp`.
  * Guarda estado en DB y JSON (`api/cache/router_ID.json`).
  * Filtra logs solo en  **error, critical, warning** .
  * Escribe archivo de log en `cron/logs/cron-rest-YYYY-MM-DD.log`.

---

## 7. Frontend (map.js + Leaflet)

### Funciones principales:

* **createMarker(router)** : crea marcador en mapa.
* **updateRouterLocation()** : guarda nuevas coordenadas al arrastrar.
* **getRouterDetailsCached()** : lee JSON de cache y arma tooltip.
* **buildTooltipHTML()** : muestra modelo, uptime, CPU, ARP, Ãºltimos eventos.
* **fetchAndDrawRouters()** : sincroniza DB â†” mapa.
* **checkRouterNow()** : verificaciÃ³n individual.
* **deleteRouter()** : eliminaciÃ³n.
* **searchInput** : bÃºsqueda de routers por nombre/IP.
* **addressInput** : bÃºsqueda de direcciones OSM.
* **renderRoutersTable()** : rellena tabla en pestaÃ±a Routers.

### Botones flotantes:

* ğŸŒ™  **theme-btn** : alterna tema.
* âš™  **settings-btn** : abre modal configuraciÃ³n.
* ğŸ”’  **lock-btn** : activa/desactiva arrastre de marcadores.
* ğŸ”„  **check-all-btn** : verifica todos los routers.

---

## 8. Backend

### Archivos clave:

* **add_router.php / edit_router.php** : guardan datos de router (con puerto REST).
* **delete_router.php** : elimina router (maneja error si no existe).
* **update_location.php** : guarda lat/lng.
* **get_router_details.php** : devuelve JSON con cache de router.
* **heartbeat.php** : notifica cambios para refrescar mapa en vivo.
* **trigger_action.php** : dispara acciones globales (ej: FORCE_CHECK_ALL).
* **ros_rest_client.php** : wrapper para consultas REST a RouterOS.

---

## 9. Panel de ConfiguraciÃ³n (settings-modal)

* **General** : cron + vista mapa.
* **Backup** : importar/exportar routers con barra de progreso.
* **Logs** : selector (cron, routers, auditorÃ­a) con fetch dinÃ¡mico.
* **Routers** : tabla HTML con listado de routers (id, nombre, ip, puerto, estado).

---

## 10. Mejoras Pendientes

* [ ] Sincronizar correctamente posiciÃ³n al agregar router con clic derecho (bug de lng=-55).
* [ ] Mejorar validaciones (ej. IP/host vÃ¡lidos).
* [ ] Cifrar `api_password` en DB.
* [ ] PaginaciÃ³n/scroll infinito para tabla de routers.
* [ ] Logs de auditorÃ­a: registrar acciones de usuario (alta, baja, mover).
* [ ] Migrar cron a **systemd** o Docker en Linux (si se despliega fuera de Windows).
* [ ] Optimizar tooltips para que muestren mÃ¡s mÃ©tricas (RAM, interfaces activas).

---

## 11. Notas finales

* La aplicaciÃ³n ya es funcional: se pueden agregar, editar, eliminar y monitorear routers con  **REST MikroTik** .
* Todos los datos clave se guardan en **MySQL** y el estado en **cache JSON** para tooltips rÃ¡pidos.
* Se soportan **import/export** de routers en JSON.
* Arquitectura modular: cualquier dev puede ampliar backend en `api/` o nuevas pestaÃ±as en frontend.

---

ğŸ‘‰ Con esta documentaciÃ³n, otro profesional tendrÃ¡ toda la  **foto completa del proyecto** , sus mÃ³dulos, quÃ© hace cada archivo y dÃ³nde estÃ¡n los puntos de mejora.

Â¿QuerÃ©s que ademÃ¡s prepare un **diagrama visual (mapa de arquitectura)** en PNG para incluir en esta documentaciÃ³n?
